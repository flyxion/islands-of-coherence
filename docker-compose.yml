# docker-compose.yml
services:
  # 1. LaTeX Compiler
  latex:
    build:
      context: .
      dockerfile: Dockerfile.latex
    volumes:
      - output:/output          # <-- shared volume
      - ./src/latex:/app        # <-- source code
    working_dir: /app
    command: make

  # 2. JupyterLab (Interactive)
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile.jupyter
    ports:
      - "8888:8888"
    volumes:
      - ./src/python:/home/jovyan/work
      - output:/home/jovyan/output      # <-- shared volume
    environment:
      JUPYTER_ENABLE_LAB: "yes"
    command: >
      bash -c "jupyter lab --ip=0.0.0.0 --allow-root --no-browser --NotebookApp.token=''"

  # 3. Batch Simulator
  simulator:
    build:
      context: .
      dockerfile: Dockerfile.simulator
    volumes:
      - output:/output          # <-- shared volume
      - ./src/python:/app       # <-- source code
    working_dir: /app
    command: python run_all_simulations.py

  # 4. Web Server
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - output:/usr/share/nginx/html:ro   # <-- serve everything from shared volume
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - latex
      - simulator

# Shared volume â€“ persists across containers and is also visible on the host at ./output
volumes:
  output: